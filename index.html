<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sendify</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>

  <h1>Sendify</h1>

  <div>
    <h2>Your ID</h2>
    <div id="statusBox">Generating ID...</div>
  </div>

  <div>
    <h2>Discovered Peers</h2>
    <div id="peerList">(No peers yet)</div>
  </div>

  <div>
    <h2>Send a File</h2>
    <input type="file" id="fileInput" />
    <button id="sendFileBtn">Send File</button>
  </div>

  <div>
    <h2>Incoming Files</h2>
    <div id="incomingFiles">(No files received yet)</div>
  </div>

  <script>
    const peer = new Peer();
    const statusBox = document.getElementById("statusBox");
    const peerList = document.getElementById("peerList");
    const fileInput = document.getElementById("fileInput");
    const sendFileBtn = document.getElementById("sendFileBtn");
    const incomingFiles = document.getElementById("incomingFiles");

    let connections = [];

    peer.on("open", (id) => {
      statusBox.textContent = `Your ID: ${id}`;
      console.log("Connected as", id);
    });

    peer.on("connection", (conn) => {
      connections.push(conn);
      updatePeerList();
      conn.on("data", (data) => receiveFile(data, conn.peer));
    });

    function updatePeerList() {
      peerList.innerHTML = "";
      connections.forEach(conn => {
        let div = document.createElement("div");
        div.textContent = conn.peer;
        peerList.appendChild(div);
      });
    }

    sendFileBtn.addEventListener("click", () => {
      let file = fileInput.files[0];
      if (!file) return alert("Select a file first!");

      let reader = new FileReader();
      reader.onload = function (e) {
        let data = { fileName: file.name, fileBuffer: e.target.result };
        connections.forEach(conn => conn.send(data));
        alert(`File "${file.name}" sent!`);
      };
      reader.readAsArrayBuffer(file);
    });

    function receiveFile(data, fromPeer) {
      let blob = new Blob([data.fileBuffer]);
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = data.fileName;
      link.textContent = `Download "${data.fileName}" from ${fromPeer}`;
      incomingFiles.appendChild(link);
    }
  </script>

</body>
</html>
